#!/bin/bash
#   author: Matus Hubinsky
#   xlogin: xhubin04
#   date:   19.03.2023

export MOLE_RC=$HOME/.config/molerc

export POSIXLY_CORRECT=yes
export LC_NUMERIC=en_US.UTF-8
export LC_COLLATE=C

set -x

print_help() {
    echo "Usage: "
    echo "      mole [-h]"
    echo "      mole [FILTERS] [DIRECTORY]"
    echo " "
    echo "COMMANDS:"
    echo "      mole list [FILTERS] [DIRECTORY]     opens certain file"
    echo " "
    echo "FILTERS:"
    echo "      [-h]                                prints help"
    echo "      [-g GROUP1[,GROUP2[,...]]] FILE     add file to a GROUP"
    echo "      [-m] [FILTERS] [DIRECTORY]          opens the file thah was edited most frequently"
    echo "      [-a DATE] YYYY-MM-DD                lists all the files edited after certain date"
    echo "      [-b DATE] YYYY-MM-DD                lists all the files edited begore certain date"
}

check() {
    if [ $(wc -c) -gt "0" ]; then
        echo "error: no files found!" >> /dev/stderr
        exit 1
    fi 
}

open() {
    # look for EDITOR, VISUAL, vi
    if [ -e "EDITOR" ]; then
        EDITOR="EDITOR"
    elif [ -e "VISUAL" ]; then
        EDITOR="VISUAL"
    else
        EDITOR="vi"
    fi
    eval "$EDITOR" "$FILE"
    log
    exit $?
}

most() {
    if [ "$FILTER" = "m" ]; then
        # Pokud byl zadán argument -m, tak skript vybere soubor, který byl pomocí skriptu otevřen (editován) nejčastěji.
        # Pokud bude při použití přepínače -m nalezeno více souborů se stejným maximálním počtem otevření, může mole vybrat kterýkoliv z nich.
        # echo "najčastejšie"
        awk 'BEGIN{max < ++c[$0]} {max = c[$0]; line = $0} END{print}'
        # uniq -c | sort -bgr
        # Pokud bylo v daném adresáři editováno skriptem více souborů, vybere se soubor, který byl pomocí skriptu otevřen (editován) jako poslední.
        # echo "posledný"
    else
        awk '{print}'
    fi
    # Pokud nebyl v daném adresáři otevřen (editován) ještě žádný soubor, případně žádný soubor nevyhovuje zadaným filtrům, jedná se o chybu.
}

date_before() {
    awk -F '|' -v date="$DATE_BEFORE" '{if (FNR>1 && $3<date) print}'
}

date_after() {
    awk -F '|' -v date="$DATE_AFTER" '{if (FNR>1 && $3>date) print}'
}

log() {
    [ -e "$FILE" ] && echo "$FILE|$GROUP|$DATE|$(realpath $FILE)" >>"$MOLE_RC"
}

ignore() {
    if [ "$IGNORE" = true ]; then
        awk -F '|' '{if ($2 == "-") print $1": "$2;}'
    else
        awk -F '|' '{print $1": "$2}'
    fi
}

DATE=$(date +%F_%H-%M-%S)
DATE_AFTER="0000-00-00"
DATE_BEFORE="9999-99-99"
FILE=""
GROUP="-"
FILTER=""
DIRECTORY=""
COMMAND=""
IGNORE=false

# check if utillity realpath is available
if ! [ -x "$(command -v realpath)" ]; then
    echo "<realpath> could not be found" >> /dev/stderr
    exit 1
fi

# look for MOLE_RC, export MOLE_RC=$HOME/.config/molerc
if [ -n "$MOLE_RC" ]; then
    if [ ! -e "$MOLE_RC" ]; then
        touch "$MOLE_RC"
    fi
else
    echo "MOLE_RC can't be found" >> /dev/stderr
    exit 1
fi

# Ak je mole spustený bez argumentov, vyberie súbor ktorý bol pomocou skriptu editovaný ako posledný
if [ $# = 0 ]; then 
    FILE=$(cat "$MOLE_RC" | awk 'BEGIN{FS="|"} END{print $1}') # uniq -c | sort -bgr |
    [ -e "$FILE" ] || { echo "error: no file!"; exit 1; }
else 
    FILE=$1
    if [ -e "$FILE" ]; then
        open
    fi
fi

# kontrola či sa jedná o príkaz alebo otvorenie súbora
if [ "$1" == "list" ] || [ "$1" == "secret-log" ]; then
    COMMAND=$1
    shift
fi

# spracovanie argumentov
while [ "$#" -gt 0 ]; do
    case "$1" in
    list | secretlog)
        shift
        ;;
    -h)
        print_help
        exit 0
        ;;
    -g)
        FILTERS+=$1
        GROUP=$2
        FILE=$3
        [ "$IGNORE" = false ] || {
            echo "error: -g and -d can't be used together" >> /dev/stderr
            exit 1
        }
        shift
        shift
        shift
        ;;
    -m)
        FILTERS+=$1
        DIRECTORY=$2
        # Pokud DIRECTORY odpovídá existujícímu adresáři, skript z daného adresáře vybere soubor, který má být otevřen.
        if [ -n "$DIRECTORY" ]; then
            # echo "vonkajší"
            :
            shift
        # Pokud nebyl zadán adresář, předpokládá se aktuální adresář.
        else
            :
        fi
        FILTER="m"
        shift
        ;;
    -a)
        FILTERS+=$1
        DATE_AFTER=$2
        date -d "$DATE_AFTER" >/dev/null 2>&1 || {
            echo "error: Date $DATE_AFTER is not in YYYY-MM-DD format" >> /dev/stderr
            exit 1
        }
        shift
        shift
        ;;
    -b)
        FILTERS+=$1
        DATE_BEFORE=$2
        date -d "$DATE_BEFORE" >/dev/null 2>&1 || {
            echo "error: Date $DATE_BEFORE is not in YYYY-MM-DD format" >> /dev/stderr
            exit 1
        }
        shift
        shift
        ;;
    -d)
        FILTERS+=$1
        IGNORE=true
        [ -z "$GROUP" ] || {
            echo "error: -g and -d can't be used together" >> /dev/stderr
            exit 1
        }
        shift
        ;;
    *)
        echo "error: Unknown argumetns!" >> /dev/stderr
        exit 1
        ;;
    esac
done

# vykonanie príkazov
case "$COMMAND" in
list)
    cat "$MOLE_RC" | date_before | date_after | ignore | sort -u | column -t -o " "
    exit 0
    ;;
secret-log)
    [ -e /home/"$USER"/.mole ] || mkdir "/home/$USER/.mole"
    cat "$MOLE_RC" | date_before | date_after | awk 'BEGIN{FS="|"} {
            if (length(arr[$4]) == 0) 
                arr[$4] = $3;
            else
                arr[$4] = arr[$4]";"$3;
        } END{ 
            for (i in arr)
                printf i";"arr[i]"\n"
         }' | sort | bzip2 -c >/home/"$USER"/.mole/log_"$USER""_""$DATE".bz2
    exit 0
    ;;
esac

# otvorenie súboru
[ -n "$FILE" ] || FILE=$1
open
