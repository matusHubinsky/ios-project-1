#!/bin/bash
#   author: Matus Hubinsky 
#   xlogin: xhubin04
#   date:   19.03.2023

export MOLE_RC=$HOME/.config/molerc

export POSIXLY_CORRECT=yes
export LC_NUMERIC=en_US.UTF-8

print_help() {
    echo "Usage: "
    echo "      mole [-h]"
    echo "      mole [FILTERS] [DIRECTORY]"
    echo " "
    echo "COMMANDS:"
    echo "      mole list [FILTERS] [DIRECTORY]     opens certain file"
    echo " "
    echo "FILTERS:"
    echo "      [-h]                                prints help"
    echo "      [-g GROUP1[,GROUP2[,...]]] FILE     add file to a GROUP"
    echo "      [-m] [FILTERS] [DIRECTORY]          opens the file thah was edited most frequently"
    echo "      [-a DATE] YYYY-MM-DD                lists all the files edited after certain date"
    echo "      [-b DATE] YYYY-MM-DD                lists all the files edited begore certain date"
}

error() {
    >&2 echo "error"
    exit 1
}

check() {
    read $OUTPUT
    if [ -n "$OUTPUT" ]; then 
        echo "$OUTPUT"
    else 
        error
    fi  
}

most() {
    # Pokud DIRECTORY odpovídá existujícímu adresáři, skript z daného adresáře vybere soubor, který má být otevřen.
    if [ -n "$DIRECTORY" ]; then
        echo "vonkajší"
    # Pokud nebyl zadán adresář, předpokládá se aktuální adresář.
    else 
        echo "aktualny"
    fi

    if [ -e $FILTER ]; then
        # Pokud byl zadán argument -m, tak skript vybere soubor, který byl pomocí skriptu otevřen (editován) nejčastěji.
        # Pokud bude při použití přepínače -m nalezeno více souborů se stejným maximálním počtem otevření, může mole vybrat kterýkoliv z nich.
        echo "najcastejsi"
        awk 'max < ++c[$0] {max = c[$0]; line = $0} END{print line}'
    else 
        # Pokud bylo v daném adresáři editováno skriptem více souborů, vybere se soubor, který byl pomocí skriptu otevřen (editován) jako poslední.
        awk 'END{print}'
        echo "posledny"
    fi

    # Pokud nebyl v daném adresáři otevřen (editován) ještě žádný soubor, případně žádný soubor nevyhovuje zadaným filtrům, jedná se o chybu.
}

secret_log() {
    echo "secret log"
}

date_before() {
    awk -F '|' -v date="$DATE_BEFORE" '{if (FNR>1 && $3<date) print}'
}

date_after() {
    awk -F '|' -v date="$DATE_AFTER" '{if (FNR>1 && $3>date) print}'
}

DATE=$(date +%F_%H-%M-%S)
DATE_AFTER="0000-00-00"
DATE_BEFORE="9999-99-99" 
FILE=""
GROUP="-"
FILTER=""
DIRECTORY=""
COMMAND=""
OUTPUT=""

# check if utillity realpath is available
if ! [ -x "$(command -v realpath)" ]; then
    echo "<realpath> could not be found"
    exit 1
fi

# look for MOLE_RC, export MOLE_RC=$HOME/.config/molerc
if [ -n "$MOLE_RC" ]; then
    if [ ! -e "$MOLE_RC" ]; then
        touch "$MOLE_RC"
    fi
else
    echo "MOLE_RC can't be found"
    exit 1
fi

set -x
while getopts ":mhg:a:b:" args 
do    
    case "${args}" in
        h)
            print_help
            exit 0
            ;;
        g)
            FILTER=$1
            GROUP=$2
            FILE=$3
            shift
            shift
            shift
            echo "$FILE|$GROUP|$DATE" >> "$MOLE_RC"
            exit 0
            ;;
        m)
            FILTER=$1
            DIRECTORY=$2            
            shift
            shift
            ;;
        a)
            echo "OPTARG: ${OPTARG}"
            FILTER=$1
            DATE_AFTER=$2
            shift
            shift
            ;;
        b)
            FILTER=$1
            DATE_BEFORE=$2
            shift
            shift
            ;;
        *)
            FILE=$1
            echo "$FILE"
            open
            exit 0
            ;;
    esac
done

shift $(($OPTIND -1))
case "$1" in
    list)   
        cat "$MOLE_RC" | date_before | date_after | awk -F '|' '{print $1" "$2" "$3}' | most
        ;;
    secret-log)
        secret_log
        ;;
    open)
        echo "$FILE|-|$DATE" >>"$MOLE_RC"
        ;;
    *)
        FILE=$1
        [ -n "$FILE" ] || error
        eval "$EDITOR" "$FILE"
        ;;
esac

exit 0